<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>User Page</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
<main>
    <h1>Hi {{username}}, number of posts: <span id="postsNum">{{ postsNum }}</span> </h1>
    <h2>User Posts:</h2>
    <ul id="user_posts_list">
        {% for post in user_posts_list %}
            <li> 
                <div>
                    Title: {{ post.title }}<br>Content: {{ post.content }}
                </div>
                <button onclick="likePost('{{ post._id }}')">Like (likes: {{ post.likes | length }})</button>
            </li>
        {% endfor %}
    </ul>
    <a href="{{ url_for('newPost') }}">
        <button>Create a post</button>
    </a>
    <a href="{{ url_for('allPosts') }}">
        <button>All posts</button>
    </a>
</main>
<script>
    function likePost(postId) {
        fetch('/likePost', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: 'post_id=' + encodeURIComponent(postId)
        })
        .then(response => response.text())
        .then(data => {
            if (data === 'success') {
                const action = data.action;
                return fetch('/getUpdatedPosts').then(response => response.json()).then(data => {
                updatePageContent(data, action, postId);
            });
        }
            else {
                throw new Error(data);
            }
        })
        .then(response => response.json())
        .then(data => {
            updatePageContent(data);
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error: ' + error.message);
        });
    }

    function updatePageContent(data, action, postId) {
        const postsNumElement = document.getElementById('postsNum');
        postsNumElement.innerText = data.postsNum;
        const userPostsList = document.getElementById('user_posts_list');
        userPostsList.innerHTML = '';
        data.user_posts_list.forEach(post => {
            const listItem = document.createElement('li');
            let likeButtonText;
            if (post._id === postId) {
            likeButtonText = action === 'liked' ? 'Unlike' : 'Like';
            } else {
            likeButtonText = post.user_liked ? 'Unlike' : 'Like';
            }
            listItem.innerHTML = `<div>Title: ${post.title}<br>Content: ${post.content}</div> <button onclick="likePost('${post._id}')">${likeButtonText} (${post.likes.length})</button>`;
        userPostsList.appendChild(listItem);
    });
}

</script>
</body>
</html>
